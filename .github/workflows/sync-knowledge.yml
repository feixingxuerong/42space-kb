name: Sync Knowledge

on:
  workflow_dispatch:
  schedule:
    # every 2 hours
    - cron: '0 */2 * * *'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout kb site
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout 42space-task (source)
        uses: actions/checkout@v4
        with:
          repository: feixingxuerong/42space-task
          ref: main
          path: source

      - name: Sync files
        run: |
          # Sync knowledge directory
          rm -rf content/knowledge
          mkdir -p content/knowledge
          cp -r source/knowledge/. content/knowledge/
          
          # Sync outputs directory (for normalized snapshots)
          rm -rf content/knowledge/outputs
          mkdir -p content/knowledge/outputs
          if [ -d "source/knowledge/outputs" ]; then
            cp -r source/knowledge/outputs/. content/knowledge/outputs/
          fi

      - name: Commit changes (if any)
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/knowledge
          git commit -m "chore(sync): update knowledge and outputs from 42space-task"
          git push
